{% extends "layout_empleado.html" %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/empleado/pedidos.css') }}">
{% endblock %}

{% block empleado_content %}

<div class="pedidos-container">

    <h2>Todos los Pedidos</h2>
    {% if pedidos %}
    <table class="tabla-pedidos">
        <thead>
            <tr>
                <th>ID Pedido</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Creado Por</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for p in pedidos %}
            <tr data-id="{{ p.id }}">
                <td>{{ p.id }}</td>
                <td>{{ p.cliente }}</td>
                <td>{{ p.total }} Bs</td>
                <td class="estado">{{ p.estado }}</td>
                <td>{{ p.fecha }}</td>
                <td>{% if p.creado_por_empleado %}Tú{% else %}Cliente{% endif %}</td>
                <td class="acciones">
                    {% if p.estado == "pendiente" %}
                        <button class="btn-accion aceptar">Aceptar</button>
                        <button class="btn-accion cancelar">Cancelar</button>
                        {% if p.creado_por_empleado %}
                        <a href="/empleado/crear_pedido?id={{ p.id }}" class="btn-accion editar">Editar</a>
                        {% endif %}
                    {% elif p.estado == "aceptado" %}
                        <button class="btn-accion entregar">Entregar</button>
                    {% endif %}
                    <button class="btn-accion detalle-link">Detalle</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="no-pedidos">No hay pedidos registrados.</p>
    {% endif %}

</div>

<!-- Ventana de detalle flotante -->
<div id="detalle-pedido-page" class="detalle-page" style="display:none;">
    <div class="detalle-content">
        <span class="close" onclick="cerrarDetalle()">&times;</span>
        <h3>Detalle del Pedido</h3>
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody id="detalle-body"></tbody>
        </table>
    </div>
</div>

<script>
const detallePage = document.getElementById("detalle-pedido-page");
const detalleBody = document.getElementById("detalle-body");

function mostrarDetalle() { detallePage.style.display = "flex"; }
function cerrarDetalle() { detallePage.style.display = "none"; detalleBody.innerHTML = ""; }
window.addEventListener("click", (e) => { if (e.target === detallePage) cerrarDetalle(); });

async function actualizarPedido(orderId, action) {
    try {
        const res = await fetch(`/empleado/pedidos/${action}/${orderId}`, { method: "POST" });
        const data = await res.json();
        if (!data.ok) return alert(data.msg || "Error al actualizar pedido");

        // Actualizar estado en la tabla
        const row = document.querySelector(`tr[data-id='${orderId}']`);
        const estadoCell = row.querySelector(".estado");
        const accionesCell = row.querySelector(".acciones");
        estadoCell.textContent = data.new_status;

        // Mostrar/ocultar botones según el estado
        const aceptarBtn = accionesCell.querySelector(".aceptar");
        const cancelarBtn = accionesCell.querySelector(".cancelar");
        const entregarBtn = accionesCell.querySelector(".entregar");
        const editarLink = accionesCell.querySelector(".editar");

        if(data.new_status === "pendiente") {
            if(aceptarBtn) aceptarBtn.style.display = "inline-block";
            if(cancelarBtn) cancelarBtn.style.display = "inline-block";
            if(editarLink) editarLink.style.display = "inline-block";
            if(entregarBtn) entregarBtn.style.display = "none";
        } else if(data.new_status === "aceptado") {
            if(aceptarBtn) aceptarBtn.style.display = "none";
            if(cancelarBtn) cancelarBtn.style.display = "none";
            if(editarLink) editarLink.style.display = "none";
            if(entregarBtn) entregarBtn.style.display = "inline-block";
        } else { // entregado o cancelado
            if(aceptarBtn) aceptarBtn.style.display = "none";
            if(cancelarBtn) cancelarBtn.style.display = "none";
            if(editarLink) editarLink.style.display = "none";
            if(entregarBtn) entregarBtn.style.display = "none";
        }

    } catch (err) { console.error(err); alert("Error al actualizar pedido"); }
}

document.addEventListener("click", async (e) => {
    const tr = e.target.closest("tr");
    if (!tr) return;
    const orderId = tr.dataset.id;

    if (e.target.classList.contains("aceptar")) {
        await actualizarPedido(orderId, "aceptar");
    } else if (e.target.classList.contains("cancelar")) {
        await actualizarPedido(orderId, "cancelar");
    } else if (e.target.classList.contains("entregar")) {
        await actualizarPedido(orderId, "entregar");
    } else if (e.target.classList.contains("detalle-link")) {
        try {
            const res = await fetch(`/empleado/pedidos/detalle/${orderId}`);
            const data = await res.json();
            if (!data.ok) return alert(data.msg || "No se pudo cargar el detalle");
            detalleBody.innerHTML = "";
            if (data.detalles.length === 0) detalleBody.innerHTML = `<tr><td colspan="3">No hay productos</td></tr>`;
            else data.detalles.forEach(d => {
                detalleBody.innerHTML += `<tr><td>${d.product_name}</td><td>${d.quantity}</td><td>${d.subtotal} Bs</td></tr>`;
            });
            mostrarDetalle();
        } catch(err){ console.error(err); alert("Error al cargar detalle"); }
    }
});
</script>

{% endblock %}

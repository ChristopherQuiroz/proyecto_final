{% extends "layout_empleado.html" %}

{% block extra_css %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/empleado/crear_pedido.css') }}">
{% endblock %}

{% block empleado_content %}

<div class="crear-pedido-container">

    <h1 class="titulo-principal">Crear Pedido</h1>

    <!-- ==========================
            PEDIDO ACTUAL
    ============================ -->
    <h2 class="subtitulo">Pedido Actual</h2>

    <div class="cliente-resumen">
        Cliente seleccionado:
        <span id="clienteResumen" class="cliente-resumen-nombre">Ninguno</span>
    </div>

    <div id="lista-pedido" class="lista-pedido"></div>

    <div id="total" class="total-box">
        Total: <span id="total-valor">0</span> Bs
    </div>

    <button id="confirmar-pedido" class="btn-confirmar" disabled>
        Registrar Pedido
    </button>

</div>

<!-- ==========================
        BUSCAR CLIENTE
============================== -->
<div class="cliente-box">
    <label class="cliente-label">Buscar Cliente:</label>
    <input type="text" id="buscarCliente" class="cliente-input" placeholder="Escribe nombre o correo...">
    <div id="sugerenciasClientes" class="sugerencias"></div>
    <input type="hidden" id="cliente">
</div>

<!-- ==========================
        BUSCAR PRODUCTO
============================== -->
<div class="search-box">
    <input type="text" id="buscarProducto" class="producto-input" placeholder="Buscar productos...">
    <div id="sugerenciasProductos" class="sugerencias"></div>
</div>

<!-- ==========================
        PRODUCTOS
============================== -->
<h2 class="subtitulo">Productos Disponibles</h2>

<section class="productos-grid" id="productosGrid">
    {% for p in productos %}
    <div class="card-producto"
         data-id="{{ p.id }}"
         data-nombre="{{ p.name }}"
         data-precio="{{ p.price }}">

        {% set img_url = url_for('static', filename='img/products/' ~ (p.image if p.image else 'default.png')) %}
        {% set default_img = url_for('static', filename='img/cupcake.png') %}

        <img src="{{ img_url }}" class="producto-img" onerror="this.src='{{ default_img }}'">

        <h3 class="producto-nombre">{{ p.name }}</h3>
        <p class="producto-precio">{{ p.price }} Bs</p>
        <p class="producto-descripcion">{{ p.description }}</p>

        <div class="pedido-control">
            <input type="number" class="cantidad" min="1" value="1">
            <button class="btn-agregar-producto">Agregar</button>
        </div>
    </div>
    {% endfor %}
</section>

<!-- ==========================
        SCRIPTS
============================== -->
<script>
//////////////////////////////////////
// Variables principales
//////////////////////////////////////
const clientes = {{ clientes | tojson }};
const inputCliente = document.getElementById("buscarCliente");
const sugerenciasBox = document.getElementById("sugerenciasClientes");
const inputClienteID = document.getElementById("cliente");
const clienteResumen = document.getElementById("clienteResumen");

const inputBuscarProducto = document.getElementById("buscarProducto");
const sugerenciasProductos = document.getElementById("sugerenciasProductos");

let pedido = [];
let total = 0;
let currentOrderId = null;

//////////////////////////////////////
// Autocomplete Clientes
//////////////////////////////////////
inputCliente.addEventListener("input", function() {
    const valor = this.value.toLowerCase();
    sugerenciasBox.innerHTML = "";

    if (!valor.trim()) {
        sugerenciasBox.style.display = "none";
        inputClienteID.value = "";
        clienteResumen.textContent = "Ninguno";
        return;
    }

    const filtrados = clientes.filter(c =>
        c.username.toLowerCase().includes(valor) ||
        (c.email && c.email.toLowerCase().includes(valor))
    );

    filtrados.forEach(c => {
        const item = document.createElement("div");
        item.classList.add("sugerencia-item");
        item.textContent = `${c.username} (${c.email})`;
        item.addEventListener("click", () => {
            inputCliente.value = c.username;
            inputClienteID.value = c.id;
            clienteResumen.textContent = c.username;
            sugerenciasBox.style.display = "none";
        });
        sugerenciasBox.appendChild(item);
    });

    sugerenciasBox.style.display = filtrados.length ? "block" : "none";
});

document.addEventListener("click", e => {
    if (!sugerenciasBox.contains(e.target) && e.target !== inputCliente) {
        sugerenciasBox.style.display = "none";
    }
});

//////////////////////////////////////
// Autocomplete Productos
//////////////////////////////////////
inputBuscarProducto.addEventListener("input", function() {
    const valor = this.value.toLowerCase();

    document.querySelectorAll(".card-producto").forEach(card => {
        const nombre = card.dataset.nombre.toLowerCase();
        card.style.display = nombre.includes(valor) ? "block" : "none";
    });
});

//////////////////////////////////////
// Lógica Pedido
//////////////////////////////////////
function actualizarLista() {
    const contenedor = document.getElementById("lista-pedido");
    const totalElemento = document.getElementById("total-valor");
    const btnConfirmar = document.getElementById("confirmar-pedido");

    contenedor.innerHTML = "";
    if (!pedido.length) {
        contenedor.innerHTML = "<p class='pedido-vacio'>Aún no hay productos agregados</p>";
        totalElemento.textContent = "0";
        btnConfirmar.disabled = true;
        return;
    }

    pedido.forEach((item, i) => {
        contenedor.innerHTML += `
            <div class="item-pedido">
                <span>${item.nombre}</span>
                <span>${item.cantidad} u.</span>
                <span>${item.subtotal.toFixed(2)} Bs</span>
                <button onclick="eliminarItem(${i})" class="btn-eliminar">X</button>
            </div>`;
    });

    totalElemento.textContent = total.toFixed(2);
    btnConfirmar.disabled = false;
}

function eliminarItem(index) {
    total -= pedido[index].subtotal;
    pedido.splice(index, 1);
    actualizarLista();
}

document.querySelectorAll(".btn-agregar-producto").forEach(btn => {
    btn.addEventListener("click", function() {
        const card = this.closest(".card-producto");
        const id = card.dataset.id;
        const nombre = card.dataset.nombre;
        const precio = Number(card.dataset.precio);
        const cantidad = Number(card.querySelector(".cantidad").value);

        if (cantidad <= 0 || isNaN(cantidad)) return alert("La cantidad debe ser mayor a 0.");

        const subtotal = precio * cantidad;
        pedido.push({ id, nombre, precio, cantidad, subtotal });
        total += subtotal;
        actualizarLista();
    });
});

//////////////////////////////////////
// Cargar pedido para edición
//////////////////////////////////////
const pedidoEditar = {{ pedido | tojson | safe }};
if (pedidoEditar) {
    currentOrderId = pedidoEditar.id;
    inputClienteID.value = pedidoEditar.cliente_id;
    clienteResumen.textContent = clientes.find(c => c.id === pedidoEditar.cliente_id)?.username || "Cliente";

    pedido = pedidoEditar.detalles.map(d => ({
        id: d.id,
        nombre: d.nombre,
        precio: d.precio,
        cantidad: d.cantidad,
        subtotal: d.subtotal
    }));

    total = pedido.reduce((acc, item) => acc + item.subtotal, 0);
    actualizarLista();

    document.querySelector(".titulo-principal").textContent += " (Editando Pedido)";
}

//////////////////////////////////////
// Registrar / Editar Pedido (POST)
//////////////////////////////////////
document.getElementById("confirmar-pedido").addEventListener("click", async function() {
    const clienteId = inputClienteID.value;
    if (!clienteId) return alert("Debes seleccionar un cliente.");
    if (!pedido.length) return alert("No hay productos en el pedido.");

    const payload = { cliente: clienteId, detalles: pedido };
    if (currentOrderId) payload.order_id = currentOrderId;

    try {
        const resp = await fetch("/empleado/crear_pedido", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (data.ok) {
            alert("Pedido registrado correctamente");
            window.location.href = "/empleado/pedidos";
        } else {
            alert(data.msg || "Ocurrió un error al registrar el pedido.");
        }
    } catch (err) {
        console.error(err);
        alert("Error de conexión al registrar el pedido.");
    }
});
</script>

{% endblock %}

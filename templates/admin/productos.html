{% extends "layout_admin.html" %}
{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/admin_empleados.css') }}">
{% endblock %}
{% block admin_content %}

<h1 class="titulo-cat">ADMIN - PRODUCTOS</h1>

<div class="buscador-agregar" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <input type="text" id="buscar-producto" placeholder="Buscar producto..." style="flex:1; min-width:200px;">
    <button id="btn-agregar-producto" onclick="mostrarModalAgregar()">Agregar Producto</button>
    <button id="btn-toggle-filtros" onclick="toggleFiltros()">Filtros ▼</button>
</div>
<!-- === CONTENEDOR FILTROS AVANZADOS === -->
<div id="filtros-container" style="display:none; margin-top:10px; gap:10px; flex-wrap:wrap;">

    <!-- Categorías -->
    <select id="filtro-categoria">
        <option value="">Todas las categorías</option>
        {% for cat in categorias %}
        <option value="{{ cat.name }}">{{ cat.name }}</option>
        {% endfor %}
    </select>

    <!-- Stock -->
    <select id="filtro-stock">
        <option value="">Todos los stocks</option>
        <option value="bajo">Bajo (&lt;5)</option>
        <option value="medio">Medio (5–20)</option>
        <option value="alto">Alto (&gt;20)</option>
    </select>

    <!-- Ordenar -->
    <select id="ordenar" class="ordenar-select">
        <option value="presentado">Presentado</option>
        <option value="az">A–Z</option>
        <option value="za">Z–A</option>
        <option value="precio-menor">Precio: menor a mayor</option>
        <option value="precio-mayor">Precio: mayor a menor</option>
    </select>

</div>

<div id="productos-grid" class="productos-grid">
    {% for producto in productos %}
    <div class="card-producto"
         data-id="{{ producto._id|string }}"
         data-name="{{ producto.name }}"
         data-description="{{ producto.description }}"
         data-category_id="{{ producto.category_id }}"
         data-price="{{ producto.price }}"
         data-quantity="{{ producto.quantity }}"
         data-status="{{ producto.status }}">
        {% set default_img = url_for('static', filename='img/products/cupcake.jpg') %}
        {% set img_url = url_for('static', filename='img/products/' ~ (producto.image if producto.image else 'cupcake.jpg')) %}
        <img src="{{ img_url }}" class="producto-img" onerror="this.src='{{ default_img }}'">

        <div class="producto-info">
            <h3>{{ producto.name }}</h3>
            <p><strong>Descripción:</strong> {{ producto.description[:50] }}{% if producto.description|length > 50 %}...{% endif %}</p>
            <p><strong>Precio:</strong> Bs {{ "%.2f"|format(producto.price|float) }}</p>
            <p><strong>Stock:</strong> {{ producto.quantity }}</p>
            <p><strong>Categoría:</strong> {{ producto.category_name }}</p>
            <p><strong>Estado:</strong> <span class="status-{{ producto.status|lower }}">{{ producto.status }}</span></p>
        </div>

        <div class="acciones-cat">
            <button class="btn-editar" 
                data-id="{{ producto._id|string }}" 
               onclick="mostrarModalEditar(this)">Editar</button>
            <a href="/admin/productos/eliminar/{{ producto._id|string }}" 
               class="btn-borrar"
               onclick="return confirm('¿Eliminar {{ producto.name }}?')">
                Eliminar
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal Agregar -->
<div id="modal-agregar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal('modal-agregar')">&times;</span>
        <form method="POST" action="/admin/productos/agregar" enctype="multipart/form-data">
            <h3>Agregar Producto</h3>
            <input type="text" name="name" placeholder="Nombre" required>
            <textarea name="description" placeholder="Descripción"></textarea>
            <select name="category" required>
                <option value="">Seleccionar categoría</option>
                {% for cat in categorias %}
                <option value="{{ cat.name }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="price" step="0.01" min="0" placeholder="Precio" required>
            <input type="number" name="quantity" min="0" placeholder="Cantidad" required>
            <select name="status">
                <option value="Disponible">Disponible</option>
                <option value="Agotado">Agotado</option>
                <option value="Descontinuado">Descontinuado</option>
            </select>
            <label for="image">Imagen:</label>
            <input type="file" name="image" accept="image/*">
            <button type="submit">Agregar</button>
        </form>
    </div>
</div>

<!-- Modal Editar -->
<div id="modal-editar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal('modal-editar')">&times;</span>
        <form id="form-editar-producto" method="POST" enctype="multipart/form-data">
            <h3>Editar Producto</h3>
            <input type="hidden" name="old_name" id="editar_old_name">
            <input type="text" name="name" id="editar_name" placeholder="Nombre" required>
            <textarea name="description" id="editar_description" placeholder="Descripción"></textarea>
            <select name="category" id="editar_category" required>
                <option value="">Seleccionar categoría</option>
                {% for cat in categorias %}
                <option value="{{ cat.name }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="price" id="editar_price" step="0.01" min="0" placeholder="Precio" required>
            <input type="number" name="quantity" id="editar_quantity" min="0" placeholder="Cantidad" required>
            <select name="status" id="editar_status">
                <option value="Disponible">Disponible</option>
                <option value="Agotado">Agotado</option>
                <option value="Descontinuado">Descontinuado</option>
            </select>
            <label for="editar_image">Imagen:</label>
            <input type="file" name="image" id="editar_image" accept="image/*">
            <br>
            <img id="editar_image_preview" src="{{ url_for('static', filename='img/products/cupcake.jpg') }}" alt="Preview" style="max-width:100px; margin-top:5px;">
            <button type="submit">Guardar Cambios</button>
        </form>
    </div>
</div>

<script>
const modalAgregar = document.getElementById('modal-agregar');
const modalEditar = document.getElementById('modal-editar');
const formEditar = document.getElementById('form-editar-producto');

function mostrarModalAgregar() {
    modalAgregar.style.display = 'block';
}

function mostrarModalEditar(btn) {
    const card = btn.closest('.card-producto');

    document.getElementById('editar_old_name').value = card.dataset.name;
    document.getElementById('editar_name').value = card.dataset.name;
    document.getElementById('editar_description').value = card.dataset.description || '';
    document.getElementById('editar_category').value = card.dataset.category_id || '';
    document.getElementById('editar_price').value = card.dataset.price;
    document.getElementById('editar_quantity').value = card.dataset.quantity;
    document.getElementById('editar_status').value = card.dataset.status || 'Disponible';

    formEditar.action = `/admin/productos/editar/${card.dataset.id}`;

    const imgPreview = document.getElementById('editar_image_preview');
    imgPreview.src = card.querySelector('.producto-img').src;

    modalEditar.style.display = 'block';
}

document.getElementById('editar_image').addEventListener('change', function(event){
    const file = event.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = function(e){
            document.getElementById('editar_image_preview').src = e.target.result;
        }
        reader.readAsDataURL(file);
    }
});

function cerrarModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

window.onclick = function(event) {
    if(event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

document.querySelectorAll('.btn-borrar').forEach(btn => {
    btn.addEventListener('click', function(e){
        e.preventDefault();
        const id = btn.closest('.card-producto').dataset.id;
        const nombre = btn.closest('.card-producto').dataset.name;
        if(confirm(`¿Seguro que quieres eliminar "${nombre}"?`)){
            window.location.href = `/admin/productos/eliminar/${id}`;
        }
    });
});

/* ============================
        TOGGLE FILTROS
============================ */
document.getElementById("btn-toggle-filtros").addEventListener("click", () => {
    const container = document.getElementById("filtros-container");
    const btn = document.getElementById("btn-toggle-filtros");

    if (container.style.display === "none") {
        container.style.display = "flex";
        btn.textContent = "⛃ Filtros ▲";
    } else {
        container.style.display = "none";
        btn.textContent = "⛃ Filtros ▼";
    }
});

/* ============================
        FUNCION FILTROS Y BUSQUEDA
============================ */
function aplicarFiltros() {
    const buscar = document.getElementById("buscar-producto").value.toLowerCase();
    const ord = document.getElementById("ordenar").value;
    const cat = document.getElementById("filtro-categoria").value;
    const stock = document.getElementById("filtro-stock").value;

    const cards = Array.from(document.querySelectorAll(".card-producto"));

    cards.forEach(card => {
        const nombre = card.dataset.name.toLowerCase();
        const desc = card.dataset.description.toLowerCase();
        const categoria = card.dataset.category;
        const cantidad = parseInt(card.dataset.quantity);
        const precio = parseFloat(card.dataset.price);

        let mostrar = true;

        // BUSCAR
        if (!(nombre.includes(buscar) || desc.includes(buscar))) mostrar = false;

        // FILTRO CATEGORÍA
        if (cat && categoria !== cat) mostrar = false;

        // FILTRO STOCK
        if (stock === "bajo" && !(cantidad < 5)) mostrar = false;
        if (stock === "medio" && !(cantidad >= 5 && cantidad <= 20)) mostrar = false;
        if (stock === "alto" && !(cantidad > 20)) mostrar = false;

        card.style.display = mostrar ? "block" : "none";
    });

    // ORDENAR SOLO LOS VISIBLES
    let visibles = cards.filter(c => c.style.display !== "none");

    visibles.sort((a, b) => {
        const n1 = a.dataset.name.toLowerCase();
        const n2 = b.dataset.name.toLowerCase();
        const p1 = parseFloat(a.dataset.price);
        const p2 = parseFloat(b.dataset.price);

        switch (ord) {
            case "az": return n1.localeCompare(n2);
            case "za": return n2.localeCompare(n1);
            case "precio-menor": return p1 - p2;
            case "precio-mayor": return p2 - p1;
            default: return 0;
        }
    });

    // Reordenar en el GRID
    const grid = document.getElementById("productos-grid");
    visibles.forEach(c => grid.appendChild(c));
}

/* Eventos */
document.getElementById("buscar-producto").addEventListener("input", aplicarFiltros);
document.getElementById("ordenar").addEventListener("change", aplicarFiltros);
document.getElementById("filtro-categoria").addEventListener("change", aplicarFiltros);
document.getElementById("filtro-stock").addEventListener("change", aplicarFiltros);

/* ============================
        CAMBIO DE COLUMNAS
============================ */
document.querySelectorAll(".vista-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        let columnas = btn.dataset.cols;
        let grid = document.getElementById("productos-grid");

        grid.className = "grid-" + columnas;

        document.querySelectorAll(".vista-btn").forEach(b => b.removeAttribute("id"));
        btn.id = "vista-activa";
    });
});
</script>

{% endblock %}

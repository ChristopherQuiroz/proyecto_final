{% extends "layout_admin.html" %}

{% block admin_content %}

<h1 class="titulo-cat">ADMIN - PRODUCTOS</h1>

<div class="buscador-agregar">
    <input type="text" id="buscar-producto" placeholder="Buscar producto...">
    <button id="btn-agregar-producto" onclick="mostrarModalAgregar()">Agregar Producto</button>
</div>

<!-- Mensajes Flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-messages">
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="productos-grid">
    {% for producto in productos %}
    <div class="card-producto"
         data-id="{{ producto._id|string }}"
         data-name="{{ producto.name }}"
         data-description="{{ producto.description }}"
         data-category="{{ producto.category }}"
         data-price="{{ producto.price }}"
         data-quantity="{{ producto.quantity }}"
         data-status="{{ producto.status }}">>
        {% set img_url = url_for('static', filename='img/products/' ~ producto.name|replace(' ', '_') ~ '.jpg') %}
        {% set default_img = url_for('static', filename='img/cupcake.png') %}
        <img src="{{ img_url }}" class="producto-img" onerror="this.src='{{ default_img }}'">

        <div class="producto-info">
            <h3>{{ producto.name }}</h3>
            <p><strong>Descripción:</strong> {{ producto.description[:50] }}{% if producto.description|length > 50 %}...{% endif %}</p>
            <p><strong>Precio:</strong> Bs {{ "%.2f"|format(producto.price|float) }}</p>
            <p><strong>Stock:</strong> {{ producto.quantity }}</p>
            <p><strong>Categoría:</strong> {{ producto.category }}</p>
            <p><strong>Estado:</strong> <span class="status-{{ producto.status|lower }}">{{ producto.status }}</span></p>
        </div>

        <div class="acciones-cat">
            <!-- Pasar el _id como string para JS -->
            <button class="btn-editar" onclick="mostrarModalEditar(this)">Editar</button>
            <a href="/admin/productos/eliminar/{{ producto._id|string }}" 
               class="btn-borrar"
               onclick="return confirm('¿Eliminar {{ producto.name }}?')">
                Eliminar
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal Agregar -->
<div id="modal-agregar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal('modal-agregar')">&times;</span>
        <form method="POST" action="/admin/productos/agregar">
            <h3>Agregar Producto</h3>
            <input type="text" name="name" placeholder="Nombre" required>
            <textarea name="description" placeholder="Descripción"></textarea>
            <select name="category" required>
                <option value="">Seleccionar categoría</option>
                {% for cat in categorias %}
                <option value="{{ cat.name }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="price" step="0.01" min="0" placeholder="Precio" required>
            <input type="number" name="quantity" min="0" placeholder="Cantidad" required>
            <select name="status">
                <option value="Disponible">Disponible</option>
                <option value="Agotado">Agotado</option>
                <option value="Descontinuado">Descontinuado</option>
            </select>
            <button type="submit">Agregar</button>
        </form>
    </div>
</div>

<!-- Modal Editar -->
<div id="modal-editar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal('modal-editar')">&times;</span>
        <form id="form-editar-producto" method="POST">
            <h3>Editar Producto</h3>
            <input type="hidden" name="old_name" id="editar_old_name">
            <input type="text" name="name" id="editar_name" placeholder="Nombre" required>
            <textarea name="description" id="editar_description" placeholder="Descripción"></textarea>
            <select name="category" id="editar_category" required>
                <option value="">Seleccionar categoría</option>
                {% for cat in categorias %}
                <option value="{{ cat.name }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <input type="number" name="price" id="editar_price" step="0.01" min="0" placeholder="Precio" required>
            <input type="number" name="quantity" id="editar_quantity" min="0" placeholder="Cantidad" required>
            <select name="status" id="editar_status">
                <option value="Disponible">Disponible</option>
                <option value="Agotado">Agotado</option>
                <option value="Descontinuado">Descontinuado</option>
            </select>
            <button type="submit">Guardar Cambios</button>
        </form>
    </div>
</div>

<script>
// Abrir modal agregar
function mostrarModalAgregar() {
    document.getElementById('modal-agregar').style.display = 'block';
}

// Abrir modal editar y cargar datos
function mostrarModalEditar(btn) {
    const card = btn.closest('.card-producto');
    
    document.getElementById('editar_old_name').value = card.dataset.name;
    document.getElementById('editar_name').value = card.dataset.name;
    document.getElementById('editar_description').value = card.dataset.description || '';
    document.getElementById('editar_category').value = card.dataset.category || '';
    document.getElementById('editar_price').value = card.dataset.price;
    document.getElementById('editar_quantity').value = card.dataset.quantity;
    document.getElementById('editar_status').value = card.dataset.status || 'Disponible';

    document.getElementById('form-editar-producto').action = `/admin/productos/editar/${card.dataset.id}`;

    document.getElementById('modal-editar').style.display = 'block';
}

// Cerrar modales
function cerrarModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Búsqueda en tiempo real
document.getElementById('buscar-producto').addEventListener('input', function(e){
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.card-producto').forEach(card => {
        const nombre = card.querySelector('h3').textContent.toLowerCase();
        const desc = card.querySelector('.producto-info p').textContent.toLowerCase();
        card.style.display = (nombre.includes(term) || desc.includes(term)) ? 'flex' : 'none';
    });
});

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    if(event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
};
</script>

{% endblock %}

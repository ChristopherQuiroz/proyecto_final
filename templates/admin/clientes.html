{% extends "layout_admin.html" %}

{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/admin_clientes.css') }}">
{% endblock %}

{% block admin_content %}

<h1 class="titulo-clientes">Gesti√≥n de Clientes</h1>

<!-- BUSCADOR -->
<div class="buscador-clientes">
    <input type="text" id="buscarCliente" placeholder="Buscar por nombre o correo...">
    <div id="sugerenciasClientes" class="sugerencias"></div>
</div>
<div class="acciones-superiores">
    <button class="btn-agregar" onclick="abrirModal()">+ Agregar Cliente</button>
</div>



<!-- TABLA CLIENTES -->
<div class="tabla-contenedor">
    <table class="tabla" id="tablaClientes">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Tel√©fono</th>
                <th>Direcci√≥n</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% if clientes %}
                {% for c in clientes %}
                <tr class="fila-cliente"
                    data-nombre="{{ c.nombre | lower }}"
                    data-correo="{{ c.correo | lower }}">
                    <td>{{ c.nombre }}</td>
                    <td>{{ c.correo }}</td>
                    <td>{{ c.telefono if c.telefono else "‚Äî" }}</td>
                    <td>{{ c.direccion if c.direccion else "‚Äî" }}</td>
                    <td class="acciones-col">
                        <button class="btn-editar" onclick="editarCliente('{{ c.id }}')">‚úè Editar</button>
                        <button class="btn-borrar" onclick="eliminarCliente('{{ c.id }}')">üóë Eliminar</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" class="sin-clientes">No hay clientes registrados.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- MODAL AGREGAR/EDITAR -->
<div class="modal" id="modalCliente">
    <div class="modal-contenido">
        <h2>Agregar Cliente</h2>
        <form id="formCliente">
            <label>Nombre:</label>
            <input type="text" name="nombre" required>
            <label>Correo:</label>
            <input type="email" name="correo" required>
            <label>Tel√©fono:</label>
            <input type="text" name="telefono">
            <label>Direcci√≥n:</label>
            <input type="text" name="direccion">
            <div class="modal-acciones">
                <button type="button" class="btn-cerrar" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-guardar">Guardar</button>
            </div>
        </form>
    </div>
</div>
<script>
let clientes = {{ clientes | tojson }};
let editandoClienteId = null; // Variable para saber si estamos editando

// ABRIR / CERRAR MODAL
function abrirModal() {
    document.getElementById("modalCliente").style.display = "flex";
    document.querySelector("#modalCliente h2").textContent = editandoClienteId ? "Editar Cliente" : "Agregar Cliente";
    const form = document.getElementById("formCliente");
    if(!editandoClienteId) form.reset();
}
function cerrarModal() {
    document.getElementById("modalCliente").style.display = "none";
    editandoClienteId = null; // Reset al cerrar
}

// EDITAR CLIENTE
function editarCliente(id) {
    const cliente = clientes.find(c => c.id === id);
    if (!cliente) return alert("Cliente no encontrado");
    editandoClienteId = id;
    abrirModal();
    const form = document.getElementById("formCliente");
    form.nombre.value = cliente.nombre;
    form.correo.value = cliente.correo;
    form.telefono.value = cliente.telefono || "";
    form.direccion.value = cliente.direccion || "";
}

// CREAR / ACTUALIZAR CLIENTE
document.getElementById("formCliente").addEventListener("submit", async function(e){
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
        nombre: formData.get("nombre"),
        correo: formData.get("correo"),
        telefono: formData.get("telefono"),
        direccion: formData.get("direccion")
    };
    let url = editandoClienteId ? `/admin/clientes/editar/${editandoClienteId}` : "/admin/clientes/crear";

    const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });
    const result = await resp.json();
    if(result.ok){
        alert(result.msg);
        location.reload();
    } else {
        alert(result.msg || "Error al guardar cliente");
    }
});

// ELIMINAR CLIENTE
async function eliminarCliente(id) {
    if(!confirm("¬øDeseas eliminar este cliente?")) return;
    const resp = await fetch(`/admin/clientes/eliminar/${id}`, { method:"POST", headers: {"Content-Type":"application/json"} });
    const result = await resp.json();
    if(result.ok) location.reload();
    else alert(result.msg || "Error");
}
const inputBuscar = document.getElementById("buscarCliente");
const tablaClientes = document.getElementById("tablaClientes").getElementsByTagName("tbody")[0];

inputBuscar.addEventListener("input", function() {
    const filtro = this.value.toLowerCase();

    for (let fila of tablaClientes.rows) {
        const nombre = fila.dataset.nombre || "";
        const correo = fila.dataset.correo || "";
        // Mostrar fila si el nombre o correo contienen el texto buscado
        if (nombre.includes(filtro) || correo.includes(filtro)) {
            fila.style.display = "";
        } else {
            fila.style.display = "none";
        }
    }
});

</script>


{% endblock %}

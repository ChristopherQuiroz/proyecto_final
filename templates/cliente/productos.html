{% extends "layout_cliente.html" %}

{% block cliente_extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cliente/productos.css') }}">
{% endblock %}

{% block cliente_content %}

<h1 class="titulo-pagina">Productos</h1>

<!-- üîé BUSCADOR + FILTROS + ORDENAR + VISTAS -->
<div class="barra-superior">

    <!-- BOT√ìN FILTROS -->
    <button class="btn-filtrar" id="btn-toggle-filtros">
        ‚õÉ Filtros ‚ñº
    </button>

    <!-- VISTAS -->
    <div class="vista-opciones">
        <button class="vista-btn" data-cols="1">‚ñ§</button>
        <button class="vista-btn" data-cols="2">‚ñ•</button>
        <button class="vista-btn" data-cols="3" id="vista-activa">‚ñ¶</button>
        <button class="vista-btn" data-cols="4">‚ñß</button>
    </div>

    <!-- BUSCAR -->
    <input type="text" id="buscar" placeholder="Buscar..." class="input-buscar">

</div>

<!-- === CONTENEDOR FILTROS AVANZADOS === -->
<div id="filtros-container" style="display:none; margin-top:10px; gap:10px; flex-wrap:wrap;">

    <!-- Categor√≠as -->
    <select id="filtro-categoria">
        <option value="">Todas las categor√≠as</option>
        {% for cat in categorias %}
        <option value="{{ cat.name }}">{{ cat.name }}</option>
        {% endfor %}
    </select>

    <!-- Stock -->
    <select id="filtro-stock">
        <option value="">Todos los stocks</option>
        <option value="bajo">Bajo (&lt;5)</option>
        <option value="medio">Medio (5‚Äì20)</option>
        <option value="alto">Alto (&gt;20)</option>
    </select>

    <!-- Ordenar -->
    <select id="ordenar" class="ordenar-select">
        <option value="presentado">Presentado</option>
        <option value="az">A‚ÄìZ</option>
        <option value="za">Z‚ÄìA</option>
        <option value="precio-menor">Precio: menor a mayor</option>
        <option value="precio-mayor">Precio: mayor a menor</option>
    </select>

</div>

<!-- ====================== GRID ======================= -->

<div id="productos-grid" class="grid-3">

    {% for p in productos %}
    <div class="producto-card"
         data-nombre="{{ p.nombre }}"
         data-descripcion="{{ p.descripcion }}"
         data-categoria="{{ p.categoria }}"
         data-precio="{{ p.precio }}"
         data-stock="{{ p.cantidad }}">

        <!-- IMAGEN -->
        <div class="card-img-container">
            <img src="{{ url_for('static', filename='img/products/' ~ p.imagen) }}"
                 onerror="this.src='{{ url_for('static', filename='img/products/cupcake.jpg') }}'">
        </div>

        <!-- INFO -->
        <div class="card-info">
            <h3>{{ p.nombre }}</h3>
            <p class="precio">Bs {{ p.precio }}</p>
        </div>

        <!-- BOT√ìN DETALLE (√≠cono carrito pero abre detalle) -->
        <a href="/cliente/producto/{{ p.id }}" class="btn-carrito">
            üõí
        </a>

    </div>
    {% endfor %}

</div>

<script>

/* ============================
        TOGGLE FILTROS
============================ */
document.getElementById("btn-toggle-filtros").addEventListener("click", () => {
    const container = document.getElementById("filtros-container");
    const btn = document.getElementById("btn-toggle-filtros");

    if (container.style.display === "none") {
        container.style.display = "flex";
        btn.textContent = "‚õÉ Filtros ‚ñ≤";
    } else {
        container.style.display = "none";
        btn.textContent = "‚õÉ Filtros ‚ñº";
    }
});

/* ============================
        APLICAR FILTROS
============================ */
function aplicarFiltros() {
    let buscar = document.getElementById("buscar").value.toLowerCase();
    let ord = document.getElementById("ordenar").value;
    let cat = document.getElementById("filtro-categoria").value;
    let stock = document.getElementById("filtro-stock").value;

    let cards = Array.from(document.querySelectorAll(".producto-card"));

    cards.forEach(card => {
        let nombre = card.dataset.nombre.toLowerCase();
        let desc = card.dataset.descripcion.toLowerCase();
        let categoria = card.dataset.categoria;
        let cantidad = parseInt(card.dataset.stock);
        let precio = parseFloat(card.dataset.precio);

        let mostrar = true;

        // BUSCAR
        if (!(nombre.includes(buscar) || desc.includes(buscar))) mostrar = false;

        // CATEGOR√çA
        if (cat && categoria !== cat) mostrar = false;

        // STOCK
        if (stock === "bajo" && !(cantidad < 5)) mostrar = false;
        if (stock === "medio" && !(cantidad >= 5 && cantidad <= 20)) mostrar = false;
        if (stock === "alto" && !(cantidad > 20)) mostrar = false;

        card.style.display = mostrar ? "block" : "none";
    });

    // ORDENAR SOLO LOS VISIBLES
    let visibles = cards.filter(c => c.style.display !== "none");

    visibles.sort((a, b) => {
        let n1 = a.dataset.nombre.toLowerCase();
        let n2 = b.dataset.nombre.toLowerCase();
        let p1 = parseFloat(a.dataset.precio);
        let p2 = parseFloat(b.dataset.precio);

        switch (ord) {
            case "az": return n1.localeCompare(n2);
            case "za": return n2.localeCompare(n1);
            case "precio-menor": return p1 - p2;
            case "precio-mayor": return p2 - p1;
            default: return 0;
        }
    });

    // Reordenar en el GRID
    let grid = document.getElementById("productos-grid");
    visibles.forEach(c => grid.appendChild(c));
}

/* Eventos */
document.getElementById("buscar").addEventListener("input", aplicarFiltros);
document.getElementById("ordenar").addEventListener("change", aplicarFiltros);
document.getElementById("filtro-categoria").addEventListener("change", aplicarFiltros);
document.getElementById("filtro-stock").addEventListener("change", aplicarFiltros);

/* ============================
        CAMBIO DE COLUMNAS
============================ */
document.querySelectorAll(".vista-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        let columnas = btn.dataset.cols;
        let grid = document.getElementById("productos-grid");

        grid.className = "grid-" + columnas;

        document.querySelectorAll(".vista-btn").forEach(b => b.removeAttribute("id"));
        btn.id = "vista-activa";
    });
});
</script>

{% endblock %}

{% extends "layout_cliente.html" %}

{% block cliente_extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cliente/categorias.css') }}">
{% endblock %}

{% block cliente_content %}

<h1 class="titulo-pagina">Categorías</h1>

<!-- BUSCADOR SOLO DE PRODUCTOS -->
<div class="barra-superior">
    <input type="text" id="buscar-producto" class="input-buscar" placeholder="Buscar productos...">
</div>

<!-- CARRUSEL DE CATEGORÍAS -->
<div class="carrusel-categorias" id="carrusel">
    {% for cat in categorias %}
    <div class="categoria-item" data-categoria="{{ cat.id }}">
        
        {% set icon_url = url_for('static', filename='img/categories/' ~ cat.icono) %}
        {% set default_icon = url_for('static', filename='img/products/cupcake.jpg') %}

        <img src="{{ icon_url }}" class="icono-categoria"
             onerror="this.src='{{ default_icon }}'">
        
        <p>{{ cat.nombre }}</p>

        <!-- contador corregido (por id) -->
        <span class="contador">{{ conteo.get(cat.id, 0) }}</span>
    </div>
    {% endfor %}
</div>

<hr>

<h2 class="titulo-lista">Productos disponibles</h2>

<!-- GRID DE PRODUCTOS -->
<div class="productos-grid" id="productosGrid">

    {% for p in productos %}
    <div class="producto-card"
        data-nombre="{{ p.nombre }}"
        data-descripcion="{{ p.descripcion }}"
        data-categoria="{{ p.categoria_id }}"
        data-precio="{{ p.precio }}">

        <!-- IMAGEN -->
        <div class="card-img-container">
            <img src="{{ url_for('static', filename='img/products/' ~ p.imagen) }}"
                 onerror="this.src='{{ url_for('static', filename='img/products/cupcake.jpg') }}'">
        </div>

        <!-- INFO -->
        <div class="card-info">
            <h3>{{ p.nombre }}</h3>
            <p class="precio">Bs {{ p.precio }}</p>
        </div>

        <a href="/cliente/producto/{{ p.id }}" class="btn-ver-producto hover-button">
            Ver producto
        </a>

    </div>
    {% endfor %}

</div>

<!-- ========= CATEGORÍA SELECCIONADA DESDE LA URL ========= -->
<script>
const categoriaSeleccionada = "{{ request.args.get('cat', '') }}";
</script>

<script>
/* ============= BUSCADOR ============= */
document.getElementById("buscar-producto").addEventListener("input", function () {
    const texto = this.value.toLowerCase();

    document.querySelectorAll(".producto-card").forEach(card => {
        const nombre = card.dataset.nombre.toLowerCase();
        const descripcion = card.dataset.descripcion.toLowerCase();

        card.style.display =
            (nombre.includes(texto) || descripcion.includes(texto))
            ? "block"
            : "none";
    });
});


/* ============= FILTRAR MANUAL POR CATEGORÍA ============= */
document.querySelectorAll(".categoria-item").forEach(item => {
    item.addEventListener("click", () => {
        const cat = item.dataset.categoria;

        document.querySelectorAll(".categoria-item").forEach(c => c.classList.remove("active"));
        item.classList.add("active");

        document.querySelectorAll(".producto-card").forEach(card => {
            card.style.display =
                (cat === "" || card.dataset.categoria === cat)
                ? "block"
                : "none";
        });
    });
});


/* ============= ACTIVAR CATEGORÍA DESDE URL ============= */
document.addEventListener("DOMContentLoaded", () => {

    if (categoriaSeleccionada !== "") {

        // Marcar categoría activa
        document.querySelectorAll(".categoria-item").forEach(item => {
            if (item.dataset.categoria === categoriaSeleccionada) {
                item.classList.add("active");
            }
        });

        // Filtrar productos automáticamente
        document.querySelectorAll(".producto-card").forEach(card => {
            card.style.display =
                (card.dataset.categoria === categoriaSeleccionada)
                ? "block"
                : "none";
        });
    }
});
</script>

{% endblock %}
